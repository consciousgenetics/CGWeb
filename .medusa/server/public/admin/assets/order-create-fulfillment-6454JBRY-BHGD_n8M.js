import{g as v}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{aa as h,S as I,ab as S,aQ as k,j as e,b as E,b9 as M,r as _,ad as T,ae as V,ba as A,t as F,v as Q,B as C,x as t,ag as L,ay as O,b1 as $,T as q,y as H}from"./index-DwAumO4s.js";import{K as P}from"./chunk-CEEYZHMN-BKk6bsNv.js";import{R as y,u as R}from"./chunk-MDIOSTKB-6EE6lyQn.js";import{S as b}from"./select-WzGNAZlw.js";import{A as z}from"./alert-CkETWLHI.js";import"./prompt-CYx1Z627.js";import"./triangles-mini-BKt9ZCCg.js";import"./x-mark-mini-BVLOBz1V.js";var B=h.object({quantity:h.record(h.string(),h.number()),location_id:h.string(),shipping_option_id:h.string().optional(),send_notification:h.boolean().optional()});function D({item:l,form:r,locationId:n}){var o,N;const{t:d}=E(),{variant:m}=O(l.variant.product_id,l.variant_id,{fields:"*inventory,*inventory.location_levels"}),{availableQuantity:j,inStockQuantity:f}=_.useMemo(()=>{var s,i;if(!m||!n)return{};const{inventory:g}=m,x=(i=(s=g[0])==null?void 0:s.location_levels)==null?void 0:i.find(c=>c.location_id===n);return x?{availableQuantity:x.available_quantity,inStockQuantity:x.stocked_quantity}:{}},[m,n]),p=0,a=Math.min(v(l),j||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx($,{src:l.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(q,{className:"txt-small",as:"span",weight:"plus",children:l.title}),((o=l.variant)==null?void 0:o.sku)&&e.jsxs("span",{children:["(",l.variant.sku,")"]})]}),e.jsx(q,{as:"div",className:"text-ui-fg-subtle txt-small",children:((N=l.variant)==null?void 0:N.title)??""})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:d("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:j||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:d("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[f||"N/A"," ",f&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",r.getValues(`quantity.${l.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(t.Field,{control:r.control,name:`quantity.${l.id}`,rules:{required:!0,min:p,max:a},render:({field:g})=>e.jsxs(t.Item,{children:[e.jsx(t.Control,{children:e.jsx(H,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...g,onChange:x=>{const s=x.target.value===""?null:Number(x.target.value);g.onChange(s),isNaN(s)||(s<p||s>a?r.setError(`quantity.${l.id}`,{type:"manual",message:d("orders.fulfillment.error.wrongQuantity",{count:a,number:a})}):r.clearErrors(`quantity.${l.id}`))}})}),e.jsx(t.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",l.quantity," ",d("fields.qty")]})]})]})]})})}function K({order:l,requiresShipping:r}){const{t:n}=E(),{handleSuccess:d}=R();S();const{mutateAsync:m,isPending:j}=M(l.id),[f,p]=_.useState(()=>(l.items||[]).filter(s=>s.requires_shipping===r&&v(s)>0)),a=T({defaultValues:{quantity:f.reduce((s,i)=>(s[i.id]=v(i),s),{}),send_notification:!l.no_notification},resolver:V(B)}),{stock_locations:o=[]}=A(),N=a.handleSubmit(async s=>{try{await m({location_id:s.location_id,no_notification:!s.send_notification,items:Object.entries(s.quantity).filter(([,i])=>!!i).map(([i,c])=>({id:i,quantity:c}))}),F.success(n("orders.fulfillment.toast.created")),d(`/orders/${l.id}`)}catch(i){F.error(i.message)}});_.useEffect(()=>{o!=null&&o.length&&a.setValue("location_id",o[0].id)},[o==null?void 0:o.length]);const g=Q({name:"location_id",control:a.control}),x=(l.items||[]).map(s=>s.requires_shipping===r&&s.detail.fulfilled_quantity);return _.useEffect(()=>{var c;const s=((c=l==null?void 0:l.items)==null?void 0:c.filter(u=>u.requires_shipping===r&&v(u)>0))||[];p(s),s.length?a.clearErrors("root"):a.setError("root",{type:"manual",message:n("orders.fulfillment.error.noItems")});const i=s.reduce((u,w)=>(u[w.id]=v(w),u),{});a.setValue("quantity",i)},[...x,r]),e.jsx(y.Form,{form:a,children:e.jsxs(P,{onSubmit:N,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(y.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(y.Close,{asChild:!0,children:e.jsx(C,{size:"small",variant:"secondary",children:n("actions.cancel")})}),e.jsx(C,{size:"small",type:"submit",isLoading:j,children:n("orders.fulfillment.create")})]})}),e.jsx(y.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(t.Field,{control:a.control,name:"location_id",render:({field:{onChange:s,ref:i,...c}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(t.Label,{children:n("fields.location")}),e.jsx(t.Hint,{children:n("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(t.Control,{children:e.jsxs(b,{onValueChange:s,...c,children:[e.jsx(b.Trigger,{className:"bg-ui-bg-base",ref:i,children:e.jsx(b.Value,{})}),e.jsx(b.Content,{children:o.map(u=>e.jsx(b.Item,{value:u.id,children:u.name},u.id))})]})})})]}),e.jsx(t.ErrorMessage,{})]})})}),e.jsxs("div",{children:[e.jsxs(t.Item,{className:"mt-8",children:[e.jsx(t.Label,{children:n("orders.fulfillment.itemsToFulfill")}),e.jsx(t.Hint,{children:n("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:f.map(s=>e.jsx(D,{form:a,item:s,locationId:g},s.id))})]}),a.formState.errors.root&&e.jsx(z,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:a.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(t.Field,{control:a.control,name:"send_notification",render:({field:{onChange:s,value:i,...c}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(t.Label,{children:n("orders.returns.sendNotification")}),e.jsx(t.Control,{children:e.jsx(t.Control,{children:e.jsx(L,{checked:!!i,onCheckedChange:s,...c})})})]}),e.jsx(t.Hint,{className:"!mt-1",children:n("orders.fulfillment.sendNotificationHint")}),e.jsx(t.ErrorMessage,{})]})})})]})})})})]})})}function le(){const{id:l}=I(),[r]=S(),n=r.get("requires_shipping")==="true",{order:d,isLoading:m,isError:j,error:f}=k(l,{fields:"currency_code,*items,*items.variant,*shipping_address"});if(j)throw f;const p=!m&&d;return e.jsx(y,{children:p&&e.jsx(K,{order:d,requiresShipping:n})})}export{le as Component};
