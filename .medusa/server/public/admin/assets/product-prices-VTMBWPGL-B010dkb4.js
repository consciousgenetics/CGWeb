import{D as F,c as $,a as B}from"./chunk-BTWRDYKW-DByg_YvC.js";import{a6 as w,ah as G,at as H,a8 as S,aj as W,S as z,U as R,j as e,b as N,au as U,i as E,r as T,ad as K,ae as L,B as C,g as k,l as q,v as A}from"./index-DwAumO4s.js";import{c as J}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as O}from"./chunk-CEEYZHMN-BKk6bsNv.js";import{R as m,u as D}from"./chunk-MDIOSTKB-6EE6lyQn.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-B4vcOU-v.js";import"./index-DTjMCBLZ.js";import"./checkbox-DOq5axzy.js";import"./prompt-CYx1Z627.js";var Q=({form:s})=>{const{store:t}=k(),{regions:a}=E({limit:9999}),{price_preferences:i}=q({}),{setCloseOnEscape:r}=D(),n=Y({currencies:t==null?void 0:t.supported_currencies,regions:a,pricePreferences:i}),o=A({control:s.control,name:"variants"});return e.jsx(F,{columns:n,data:o,state:s,onEditingChange:j=>r(!j)})},X=B(),Y=({currencies:s=[],regions:t=[],pricePreferences:a=[]})=>{const{t:i}=N();return T.useMemo(()=>[X.column({id:i("fields.title"),header:i("fields.title"),cell:r=>{const n=r.row.original;return e.jsx(F.ReadonlyCell,{context:r,children:e.jsx("div",{className:"flex h-full w-full items-center gap-x-2 overflow-hidden",children:e.jsx("span",{className:"truncate",children:n.title})})})},disableHiding:!0}),...$({currencies:s.map(r=>r.currency_code),regions:t,pricePreferences:a,getFieldName:(r,n)=>{var o;return(o=r.column.id)!=null&&o.startsWith("currency_prices")?`variants.${r.row.index}.prices.${n}`:`variants.${r.row.index}.prices.${n}`},t:i})],[i,s,t,a])},Z=w({variants:G(w({prices:H(S(),S().or(W()).optional()).optional()}))}),I=({product:s,variantId:t})=>{const{t:a}=N(),{handleSuccess:i}=D(),{mutateAsync:r,isPending:n}=U(s.id),{regions:o}=E({limit:9999}),j=T.useMemo(()=>o!=null&&o.length?o.reduce((c,l)=>(c[l.id]=l.currency_code,c),{}):{},[o]),h=t?s.variants.filter(c=>c.id===t):s.variants,y=K({defaultValues:{variants:h.map(c=>({title:c.title,prices:c.prices.reduce((l,d)=>{var u;return(u=d.rules)!=null&&u.region_id?l[d.rules.region_id]=d.amount:l[d.currency_code]=d.amount,l},{})}))},resolver:L(Z,{})}),M=y.handleSubmit(async c=>{const l=c.variants.map((d,u)=>({id:h[u].id,prices:Object.entries(d.prices||{}).filter(([p,x])=>x!==""&&typeof x<"u").map(([p,x])=>{var P,b;const f=p.startsWith("reg_")?p:void 0,_=p.startsWith("reg_")?j[f]:p;let g;f?g=(P=h[u].prices.find(v=>v.rules.region_id===f))==null?void 0:P.id:g=(b=h[u].prices.find(v=>v.currency_code===_&&Object.keys(v.rules??{}).length===0))==null?void 0:b.id;const V=J(x);return{id:g,currency_code:_,amount:V,...f?{rules:{region_id:f}}:{}}})}));await r(l,{onSuccess:()=>{i("..")}})});return e.jsx(m.Form,{form:y,children:e.jsxs(O,{onSubmit:M,className:"flex size-full flex-col",children:[e.jsx(m.Header,{}),e.jsx(m.Body,{className:"flex flex-col overflow-hidden",children:e.jsx(Q,{form:y})}),e.jsx(m.Footer,{children:e.jsxs("div",{className:"flex w-full items-center justify-end gap-x-2",children:[e.jsx(m.Close,{asChild:!0,children:e.jsx(C,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(C,{type:"submit",variant:"primary",size:"small",isLoading:n,children:a("actions.save")})]})})]})})},de=()=>{const{id:s,variant_id:t}=z(),{product:a,isLoading:i,isError:r,error:n}=R(s);if(r)throw n;return e.jsx(m,{children:!i&&a&&e.jsx(I,{product:a,variantId:t})})};export{de as Component};
